# Claude Flow - Built on top of Claude Dev
FROM andreashurst/claude-docker:latest-dev

# Switch to root for installations
USER root

# Install Python and build tools (needed for Hive-Mine and other tools)
RUN apk add --no-cache \
    python3 \
    py3-pip \
    gcc \
    g++ \
    musl-dev \
    linux-headers \
    chromium \
    chromium-chromedriver \
    firefox \
    && rm -rf /var/cache/apk/*

# Install Playwright properly (both as package and CLI)
RUN npm install -g playwright@latest @playwright/test && \
    # Fix npm global binaries to be accessible
    echo 'export PATH="$(npm config get prefix)/bin:$PATH"' >> /etc/profile && \
    echo 'export PATH="$(npm config get prefix)/bin:$PATH"' >> /etc/bash.bashrc && \
    playwright install chromium firefox webkit && \
    playwright install-deps || true

# Playwright is installed globally and available as direct command
# No wrappers needed since npm install -g creates the binary

# Install additional Flow-specific tools
# Note: MCP servers already installed in base image as root
RUN npm install -g \
    @playwright/mcp \
    claude-flow@latest || true && \
    # Create symlinks for all claude-flow related commands
    ln -sf $(npm config get prefix)/bin/claude-flow /usr/local/bin/claude-flow 2>/dev/null || true && \
    ln -sf $(npm config get prefix)/bin/mcp /usr/local/bin/mcp 2>/dev/null || true

# Install Python MCP servers
RUN pip3 install --break-system-packages \
    mcp-server-git \
    hive-mine || true

# Install Deno for additional scripting capabilities
RUN curl -fsSL https://deno.land/install.sh | sh && \
    mv /root/.deno /usr/local/deno && \
    ln -s /usr/local/deno/bin/deno /usr/local/bin/deno

# Create Playwright cache directory
RUN mkdir -p /home/claude/.cache/ms-playwright && \
    chown -R claude:claude /home/claude/.cache/ms-playwright

# Flow scripts and docs will be created by entrypoint
# No static files needed

# Environment variables for Flow
ENV PLAYWRIGHT_BROWSERS_PATH=/home/claude/.cache/ms-playwright \
    PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 \
    DENO_INSTALL="/usr/local/deno" \
    PATH="/home/claude/.npm-global/bin:/usr/local/bin:/usr/local/deno/bin:$PATH" \
    FLOW_MODE=true

# No custom flow-* commands needed
# Claude Code knows standard commands like:
# - playwright test
# - playwright show-report
# - playwright codegen
# - playwright install

# Copy entrypoint script
COPY docker/entrypoint.flow.sh /docker/entrypoint.sh
RUN chmod +x /docker/entrypoint.sh

# Keep working directory
WORKDIR /var/www/html

# Note: We don't set ENTRYPOINT here as claude-flow script will handle it
