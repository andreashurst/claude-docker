#!/bin/bash

# Claude Flow Universal Installer v3.2.0
# Advanced environment with Playwright and testing tools

set -e

VERSION="3.2.0"
CONTAINER_NAME="claude-flow"

# Load shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-docker.lib.sh"

CURRENT_DIR=$(pwd)

# Create compose files for Flow
claude_docker_create_files() {
    # For claude-flow, create docker-compose.yml with webserver if it doesn't exist
    claude_docker_create_flow_compose_with_webserver

    # Ask about override file using library function
    claude_docker_ask_replace_override || return 0

    # MCP configuration would go in container, not in project
    # Removed MCP config creation from project directory

    # Create docker-compose.override.yml using library
    claude_docker_create_override "flow" "$CURRENT_DIR"

    claude_docker_update_gitignore
}

# Main function
main() {
    echo "##################################################################"
    echo "üîó Claude-Flow in Docker v$VERSION"
    echo "##################################################################"
    echo ""

    claude_docker_check

    # Only create files if container is not already running
    if ! claude_docker_is_running "$CONTAINER_NAME"; then
        claude_docker_create_files
        # Create playwright.config.js ONLY if it doesn't exist
        claude_docker_playwright_config
    fi

    claude_docker_connect "$CONTAINER_NAME"

}

# Handle arguments
case "${1:-}" in
    -v|--version) echo "v$VERSION"; exit 0 ;;
    --stop) docker compose stop $CONTAINER_NAME; exit 0 ;;
    --clean)
        docker compose down -v  # -v removes volumes too
        rm -f docker-compose.override.yml playwright.config.js
        echo "‚úÖ Removed container, volume and config"
        exit 0
        ;;
    --root)
        echo "üîê Starting as root (backdoor mode)..."
        docker compose up -d
        sleep 3
        claude_docker_connect_as_root "$CONTAINER_NAME"
        ;;
    -h|--help)
        echo "Usage: $0 [--version|--stop|--clean|--root|--help]"
        echo "  --stop    Stop the container"
        echo "  --clean   Remove container, volume and config"
        echo "  --root    Start with root access (backdoor)"
        exit 0
        ;;
    "") main ;;
    *) echo "Unknown option: $1"; exit 1 ;;
esac
