#!/bin/bash
#
# MCP Server Status Check
# Shows status of all configured MCP servers
#

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

MCP_CONFIG="/home/claude/mcp/config.json"

if [ ! -f "$MCP_CONFIG" ]; then
    echo -e "${RED}❌ MCP config not found: $MCP_CONFIG${NC}"
    echo "Are you running inside a Claude container?"
    exit 1
fi

echo "════════════════════════════════════════════════════════"
echo "  📡 MCP Server Status"
echo "════════════════════════════════════════════════════════"
echo ""

# Parse MCP config and test each server
echo "$(<$MCP_CONFIG)" | jq -r '.mcpServers | to_entries[] | "\(.key)|\(.value.command)|\(.value.description)"' | while IFS='|' read -r name command description; do
    echo -e "${CYAN}▸ $name${NC}"
    echo "  Description: $description"

    # Check if command exists
    if command -v "$command" &> /dev/null; then
        echo -e "  Command: ${GREEN}✓${NC} $command"
    else
        echo -e "  Command: ${RED}✗${NC} $command (not found)"
    fi

    # Check if it's a Node.js server and file exists
    if [ "$command" = "node" ]; then
        server_path=$(echo "$(<$MCP_CONFIG)" | jq -r ".mcpServers.\"$name\".args[0]")
        if [ -f "$server_path" ]; then
            echo -e "  Server: ${GREEN}✓${NC} $(basename $server_path)"
            file_size=$(du -h "$server_path" | cut -f1)
            echo "  Size: $file_size"
        else
            echo -e "  Server: ${RED}✗${NC} $server_path (not found)"
        fi
    fi

    echo ""
done

# Show context files status
echo "════════════════════════════════════════════════════════"
echo "  📚 Context Files"
echo "════════════════════════════════════════════════════════"
echo ""

CONTEXT_DIR="/home/claude/mcp/context"
if [ -d "$CONTEXT_DIR" ]; then
    total_size=$(du -sh "$CONTEXT_DIR" 2>/dev/null | cut -f1)
    file_count=$(find "$CONTEXT_DIR" -type f | wc -l)

    echo -e "${GREEN}✓${NC} Context directory: $CONTEXT_DIR"
    echo "  Total size: $total_size"
    echo "  Files: $file_count"
    echo ""

    # List context directories with sizes
    for dir in "$CONTEXT_DIR"/*; do
        if [ -d "$dir" ]; then
            dir_name=$(basename "$dir")
            dir_size=$(du -sh "$dir" 2>/dev/null | cut -f1)
            file_count=$(find "$dir" -type f | wc -l)
            echo "  • $dir_name: $dir_size ($file_count files)"
        fi
    done
else
    echo -e "${RED}✗${NC} Context directory not found"
fi

echo ""
echo "════════════════════════════════════════════════════════"
