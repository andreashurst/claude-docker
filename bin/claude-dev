#!/bin/bash
# Standalone claude-dev script using Docker Hub image

# Check if Docker is running
if ! docker info >/dev/null 2>&1; then
    echo "Error: Docker is not running. Please start Docker and try again."
    exit 1
fi

# Get current directory
CURRENT_DIR=$(pwd)

# Create temporary docker-compose file
cat > /tmp/claude-dev-compose.yml << EOF
services:
  claude-dev:
    image: andreashurst/claude-docker:latest-dev
    working_dir: /var/www/html
    
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    
    volumes:
      - ${CURRENT_DIR}:/var/www/html:cached
      - claude-dev-cache:/home/claude/.cache
      - claude-dev-npm:/home/claude/.npm
      - claude-dev-config:/home/claude/.config
    
    environment:
      - NODE_ENV=development
      - NPM_CONFIG_CACHE=/home/claude/.cache/npm
      - CLAUDE_CONFIG_PATH=/home/claude/.config/claude
      - CLAUDE_PROJECT_PATH=${CURRENT_DIR}
      - FRONTEND_URL=${FRONTEND_URL:-localhost:3000}
      - PROJECT_PATH=${CURRENT_DIR}
      - FRONTEND_PORT=${FRONTEND_PORT:-3000}
    
    stdin_open: true
    tty: true
    
    security_opt:
      - no-new-privileges:true
    
    restart: "no"

volumes:
  claude-dev-cache:
    driver: local
  claude-dev-npm:
    driver: local
  claude-dev-config:
    driver: local
EOF

# Run with temporary compose file
docker compose -f /tmp/claude-dev-compose.yml up "$@"

# Cleanup
rm -f /tmp/claude-dev-compose.yml