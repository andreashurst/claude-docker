FROM node:22-alpine

# Security updates and essential packages
RUN apk update && apk upgrade && \
    apk add --no-cache \
    git \
    bash \
    curl \
    wget \
    unzip \
    ca-certificates \
    jq \
    ripgrep \
    tree \
    htop \
    netcat-openbsd \
    nano \
    vim \
    make \
    openssh-client \
    iputils \
    && rm -rf /var/cache/apk/*

# Create non-root user
RUN addgroup -g 1010 claude && \
    adduser -D -s /bin/bash -u 1010 -G claude claude

# Install Claude Code globally
RUN npm install -g @anthropic-ai/claude-code

# Create network testing scripts
RUN echo '#!/bin/sh\n\
echo "Testing host.docker.internal connectivity..."\n\
ping -c 3 host.docker.internal\n\
echo ""\n\
echo "Testing common ports..."\n\
for port in 3000 5173 8000 5000 5432 3306 27017; do\n\
  nc -z -v -w3 host.docker.internal $port 2>/dev/null && echo "Port $port: OPEN" || echo "Port $port: CLOSED"\n\
done' > /usr/local/bin/test-host-connectivity && \
    chmod +x /usr/local/bin/test-host-connectivity

RUN echo '#!/bin/sh\n\
if [ -z "$1" ]; then\n\
  echo "Usage: test-port PORT"\n\
  echo "Example: test-port 3000"\n\
  exit 1\n\
fi\n\
PORT=$1\n\
echo "Testing host.docker.internal:$PORT..."\n\
nc -z -v -w5 host.docker.internal $PORT 2>/dev/null && echo "Port $PORT: OPEN" || echo "Port $PORT: CLOSED"' > /usr/local/bin/test-port && \
    chmod +x /usr/local/bin/test-port

# Copy entrypoint script
COPY docker/entrypoint-dev.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Copy Claude settings configuration for dev environment
COPY config/dev.settings.local.json /home/claude/.claude/settings.local.json

# Create config directory for Claude
RUN mkdir -p /home/claude/.config && \
    mkdir -p /home/claude/.claude && \
    chown -R claude:claude /home/claude/.config && \
    chown -R claude:claude /home/claude/.claude && \
    chown claude:claude /home/claude/.claude/settings.local.json && \
    chmod 644 /home/claude/.claude/settings.local.json

# NPM will use temp directories automatically
ENV NPM_CONFIG_CACHE=/tmp/npm-cache

# Set working directory
WORKDIR /var/www/html

# Switch to non-root user
USER claude

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]