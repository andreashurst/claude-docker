FROM node:22-slim

# Update package index and install dependencies
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
    git \
    curl \
    wget \
    unzip \
    python3 \
    python3-pip \
    python3-dev \
    build-essential \
    sqlite3 \
    libsqlite3-dev \
    ca-certificates \
    bash \
    jq \
    ripgrep \
    tree \
    htop \
    netcat-openbsd \
    nano \
    vim-tiny \
    make \
    openssh-client \
    iputils-ping \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -g 1010 claude && \
    useradd -d /home/claude -s /bin/bash -u 1010 -g claude claude

# Add claude to sudoers
RUN echo "claude ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Install Deno as claude user
USER claude
WORKDIR /home/claude
RUN curl -fsSL https://deno.land/install.sh | sh

# Switch back to root for global installations
USER root

# Install global packages
RUN npm install -g pnpm @anthropic-ai/claude-code

# Install Playwright and browsers as root
RUN npm install -g playwright@latest && \
    npx playwright install --with-deps chromium firefox webkit && \
    npx playwright install-deps

# Install Claude Flow orchestration tool and verify installation
RUN npm install -g claude-flow@2.0.0-alpha.91 && \
    which claude-flow && \
    claude-flow --version || echo "claude-flow installation verification failed"

# Install MCP servers for Claude Code integration
RUN npm install -g @playwright/mcp
RUN npm install -g @modelcontextprotocol/server-filesystem
# Install Git MCP server (fallback if pip fails)
RUN pip3 install --upgrade pip setuptools wheel && \
    pip3 install mcp-server-git || echo "Warning: mcp-server-git installation failed, continuing without Git MCP support"

# Create directories
RUN mkdir -p /usr/local/share/claude/examples && \
    mkdir -p /usr/local/share/docs && \
    mkdir -p /usr/local/lib/node_modules/playwright && \
    mkdir -p /home/claude/.config/claude && \
    mkdir -p /home/claude/.claude && \
    mkdir -p /home/claude/.cache/ms-playwright

# Create symlink for playwright CLI access
RUN ln -sf /usr/local/lib/node_modules/playwright/cli.js /usr/local/bin/playwright-cli

# Copy entrypoint script
COPY docker/entrypoint.flow.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Copy Claude settings configuration to the correct location
COPY config/flow.settings.local.json /home/claude/.claude/settings.local.json

# Copy Playwright scripts and examples
COPY config/flow.universal-screenshot.mjs /usr/local/bin/screenshot
COPY config/flow.playwright.config.example.js /usr/local/share/claude/examples/playwright.config.js
COPY config/flow.example-vite-test.spec.js /usr/local/share/claude/examples/example-test.spec.js
COPY docs/NETWORKING.md /usr/local/share/docs/NETWORKING.md
COPY docs/PLAYWRIGHT.md /usr/local/share/docs/PLAYWRIGHT.md

# Verify copied files
RUN ls -lah /usr/local/share/docs
RUN ls -lah /usr/local/share/claude
RUN ls -lah /usr/local/share/claude/examples

# Copy wrapper scripts and tools
COPY bin/curl /usr/local/bin/curl-docker
COPY bin/playwright /usr/local/bin/playwright-docker
COPY bin/vite-proxy /usr/local/bin/vite-proxy
COPY bin/detect-environment /usr/local/bin/detect-environment
COPY scripts/* /usr/local/share/claude/

# Make scripts executable
RUN chmod +x /usr/local/bin/curl-docker && \
    chmod +x /usr/local/bin/playwright-docker && \
    chmod +x /usr/local/bin/vite-proxy && \
    chmod +x /usr/local/bin/detect-environment && \
    chmod +x /usr/local/share/claude/*

# Set proper ownership and permissions for claude user directories
RUN chown -R claude:claude /home/claude/.config && \
    chown -R claude:claude /home/claude/.claude && \
    chmod 644 /home/claude/.claude/settings.local.json

# Copy Playwright browsers to user directory
RUN cp -r /root/.cache/ms-playwright/* /home/claude/.cache/ms-playwright/ 2>/dev/null || true && \
    chown -R claude:claude /home/claude/.cache/ms-playwright

# Set environment variables
ENV NPM_CONFIG_CACHE=/tmp/npm-cache \
    PLAYWRIGHT_BROWSERS_PATH=/home/claude/.cache/ms-playwright \
    NODE_ENV=development \
    DOCKER_ENV=true \
    AUTH_DIR=/home/claude/.claude-auth \
    PATH="/home/claude/.deno/bin:$PATH" \
    DENO_INSTALL="/home/claude/.deno" \
    DOCKER_CONTAINER=true \
    VITE_HOST=host.docker.internal

# Create network testing scripts
RUN echo '#!/bin/bash\n\
echo "Testing host.docker.internal connectivity..."\n\
ping -c 3 host.docker.internal\n\
echo ""\n\
echo "Testing common ports..."\n\
for port in 3000 5173 8000 5000 5432 3306 27017; do\n\
  timeout 3 bash -c "</dev/tcp/host.docker.internal/$port" && echo "Port $port: OPEN" || echo "Port $port: CLOSED"\n\
done' > /usr/local/bin/test-host-connectivity && \
    chmod +x /usr/local/bin/test-host-connectivity

RUN echo '#!/bin/bash\n\
if [ -z "$1" ]; then\n\
  echo "Usage: test-port PORT"\n\
  echo "Example: test-port 3000"\n\
  exit 1\n\
fi\n\
PORT=$1\n\
echo "Testing host.docker.internal:$PORT..."\n\
timeout 5 bash -c "</dev/tcp/host.docker.internal/$PORT" && echo "Port $PORT: OPEN" || echo "Port $PORT: CLOSED"' > /usr/local/bin/test-port && \
    chmod +x /usr/local/bin/test-port

# Set working directory
WORKDIR /var/www/html

# IMPORTANT: Keep as root user so entrypoint can do root operations
# The entrypoint script will switch to claude user at the end

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
